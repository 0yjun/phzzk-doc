# 스트리밍 시나리오

## 스트리머 방송 시작 시나리오

1. **스트리머가 방송을 시작한다**
   - (Web 서버 → WAS 서버):  
     웹 서버는 사용자 인터페이스(UI)를 제공하고, WAS 서버는 방송 시작을 처리한다.

2. **방송 정보가 기록된다**
   - (WAS 서버):  
     WAS 서버는 방송의 메타데이터를 기록한다.

3. **미디어 스트리밍 서버가 실시간 스트림을 변환한다**
   - (WAS 서버 → 미디어 스트리밍 서버):  
     WAS 서버가 미디어 스트리밍 서버에 스트리머의 스트림 전송 시작을 지시하고, 미디어 스트리밍 서버가 실시간으로 스트림을 인코딩/변환한다.

4. **미디어 스트리밍 서버가 실시간 스트림을 시청자에게 전송한다**
   - (미디어 스트리밍 서버 → 시청자):  
     미디어 스트리밍 서버가 변환된 스트림을 시청자에게 실시간 전송한다.

5. **미디어 스트리밍 서버가 실시간 스트림을 미디어 저장 서버로 보낸다**
   - (미디어 스트리밍 서버 → 미디어 저장 서버):  
     미디어 스트리밍 서버가 실시간 스트림을 녹화본으로 저장하고, 녹화본은 `/data/yyyy/mm/dd/hh` 경로에 `yyyyddmmhh_uuid`로 저장된다.

---

## 채팅 기능 활성화

1. **실시간 채팅 관리**
   - (Web 서버 → WAS 서버 → WebSocket):  
     WAS 서버가 WebSocket을 통해 실시간 채팅을 관리한다.

2. **시청자가 채팅을 입력한다**
   - (시청자 → Web 서버 → WAS 서버):  
     시청자가 WebSocket을 통해 실시간으로 메시지를 전송한다.

3. **스트리머가 채팅에 응답한다**
   - (스트리머 → Web 서버 → WAS 서버 → 시청자):  
     스트리머가 WebSocket을 통해 실시간으로 채팅에 응답한다.

---

## 다시보기 시나리오

1. **사용자가 웹 페이지에서 다시보기 리스트를 조회한다**
   - (WAS → Web):  
     사용자가 웹 페이지에서 다시보기 리스트 조회 요청을 보내고, WAS 서버가 다시보기 방송 목록을 전달한다. Web 서버가 UI에 다시보기 리스트를 표시한다.

2. **사용자가 특정 다시보기 방송을 클릭한다**
   - (Web → WAS):  
     사용자가 특정 방송을 클릭하면, Web 서버가 클릭한 방송 정보를 WAS 서버로 전달한다.

3. **WAS 서버가 다시보기가 저장된 경로를 확인한다**
   - (WAS → 미디어 저장 서버):  
     WAS 서버가 해당 방송의 메타데이터 및 저장 경로를 확인하고, 미디어 저장 서버에 저장된 다시보기 영상 요청을 보낸다.

4. **미디어 저장 서버가 다시보기 영상을 제공한다**
   - (미디어 저장 서버 → Web):  
     미디어 저장 서버가 영상 제공하고, Web 서버가 사용자에게 다시보기 영상 스트리밍을 수행한다.

---

## 시청자 입장 및 퇴장 감지 시나리오

1. **스트리머가 방송을 시작한다**
   - (Web 서버 → WAS 서버):  
     웹 서버는 사용자 인터페이스(UI)를 제공한다. WAS 서버는 방송 시작을 처리하고, 현재 시청자 수를 0으로 초기화하며 방송 정보를 기록한다.

2. **시청자가 방송 페이지에 접속한다**
   - (시청자 → Web 서버):  
     시청자가 방송 페이지에 접속하면 웹 서버는 WebSocket 연결을 생성한다.

3. **WebSocket 연결 후 입장 알림 전송**
   - (클라이언트 → WAS 서버):  
     WebSocket 연결이 성공하면, 클라이언트는 "입장" 이벤트를 서버로 전송한다. 클라이언트는 join 메시지를 서버에 전송한다.

4. **입장 이벤트 수신 및 대기**
   - (WAS 서버):  
     WAS 서버는 "입장" 이벤트를 수신하고, 현재 시청자 수를 0.5초의 지연 후에 1 증가시키기로 설정한다. 서버는 해당 시청자를 대기 목록에 추가한다.

5. **현재 시청자 수 집계**
   - (WAS 서버):  
     WAS 서버는 대기 목록에 있는 사용자들의 입장 이벤트를 주기적으로 확인하고, 일정 시간(예: 5초) 후에 현재 시청자 수를 1 증가시키며, 이를 모든 시청자에게 알린다.

6. **퇴장 감지 및 대기**
   - (클라이언트 → WAS 서버):  
     사용자가 방송을 종료하면 beforeunload 이벤트를 통해 "퇴장" 메시지를 서버로 전송한다.

7. **퇴장 이벤트 수신 및 대기**
   - (WAS 서버):  
     WAS 서버는 "퇴장" 이벤트를 수신하고, 현재 시청자 수를 1 감소시키기로 설정한다. 서버는 해당 시청자를 대기 목록에 추가한다.

8. **현재 시청자 수 업데이트**
   - (WAS 서버):  
     WAS 서버는 대기 목록에 있는 사용자들의 퇴장 이벤트를 주기적으로 확인하고, 일정 시간(예: 5초) 후에 현재 시청자 수를 1 감소시키며, 이를 모든 시청자에게 알린다.

9. **모든 시청자에게 업데이트 전송**
   - (WAS 서버 → 모든 클라이언트):  
     입장 및 퇴장 이벤트 후 업데이트된 현재 시청자 수를 모든 클라이언트에게 전송하여 실시간으로 시청자 수를 동기화한다.

---

## 스트리밍 연결이 끊겼을 때 시나리오

1. **연결 끊김 발생**  
   스트리밍 서버와 미디어 저장 서버 간의 연결이 끊긴다. 이로 인해 실시간 데이터 전송이 중단된다.

2. **미디어 저장 서버의 동작**  
   미디어 저장 서버는 스트리밍 서버에서 전송하는 스트림 데이터의 저장을 중지한다. 연결이 끊기기 이전까지의 동영상 파일 주소는 미디어 저장 서버에 안전하게 저장된다.

3. **연결 재개**
   - **5분 이내 재연결:**  
     스트리밍 서버가 5분 이내에 다시 연결되면, 새로운 비디오 파일이 생성된다. 이와 함께, 이 비디오 파일의 주소를 저장하는 새로운 비디오 엔티티가 생성된다.
   - **연결이 5분 이상 끊긴 경우:**  
     기존 스트림은 종료되며 스트리머는 새로운 방송을 시작해야 한다.

4. **시청자 경험**  
   시청자는 방송이 끊기기 전까지의 동영상을 다시 보기 기능을 통해 시청할 수 있으며, 새로운 방송이 시작되면 별도로 알림을 받거나 UI에서 확인할 수 있다.
